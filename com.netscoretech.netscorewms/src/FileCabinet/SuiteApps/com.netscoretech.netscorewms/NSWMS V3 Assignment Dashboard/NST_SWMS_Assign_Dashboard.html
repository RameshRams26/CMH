<html lang="en" ng-app="assignApp" ng-controller="assignCtrl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Supervisor Manual Assignment</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" />
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="customCss" />
    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <script src="customJs"></script>
    <script id="myDataObj" type="application/json">
      dataObj
    </script>
  </head>
  <body>
    <div ng-show="loading" class="loader loader-wrapper">
      <img src="loaderUrl" />
    </div>
    <div class="container-fluid py-3">
      <!-- Header -->
      <div class="page-header">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h4 class="mb-1">
              <i class="bi bi-clipboard-check me-2 text-primary"></i>
              Assignment Dashboard
            </h4>
            <p class="text-muted mb-0 small">Manage and assign picking tasks to your team</p>
          </div>
          <div class="d-flex gap-2 align-items-center">
            <span class="badge rounded-pill bg-secondary" ng-if="pendingChangesCount > 0">
              {{pendingChangesCount}} pending change{{pendingChangesCount>1?'s':''}}
            </span>
            <button class="btn btn-sm btn-outline-light" ng-click="refreshScreen()">
              <i class="bi bi-arrow-repeat"></i>
              Refresh
            </button>
            <button class="btn btn-sm btn-primary" ng-click="saveAssignments()" ng-disabled="pendingChangesCount===0">
              <i class="bi bi-check2-circle"></i>
              Save
            </button>
          </div>
        </div>
      </div>

      <!-- Pending changes info -->
      <div class="pending-bar" ng-if="pendingChangesCount > 0">
        <div class="d-flex align-items-center gap-2">
          <i class="bi bi-pencil-square"></i>
          <span class="small">
            You have unsaved assignments. They won't affect picker status until you click
            <b>Save</b>
            .
          </span>
        </div>
        <!-- <div>
          <span class="badge bg-warning text-dark me-2">Drafts: {{pendingChangesCount}}</span>
          <button class="btn btn-sm btn-primary" ng-click="saveAssignments()">
            <i class="bi bi-check2-circle"></i>
            Save now
          </button>
        </div> -->
      </div>

      <!-- Stats Bar -->
      <div class="stats-bar">
        <div class="stat-item">
          <div class="stat-label">Pending SOs</div>
          <div class="stat-value">{{ordersCount}}</div>
          <div class="small text-muted">
            <i class="bi bi-arrow-up text-success"></i>
            So Far
          </div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Items to Assign</div>
          <div class="stat-value">{{totalQty}}</div>
          <div class="small text-muted">Across all orders</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Available Pickers</div>
          <div class="stat-value">{{getAvailablePickers().length}}</div>
          <div class="small text-muted">Ready for assignments</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Busy Pickers</div>
          <div class="stat-value">{{getBusyPickers().length}}</div>
          <div class="small text-muted">Currently working</div>
        </div>
      </div>

      <!-- Filters Card -->
      <div class="filter-card">
        <div class="row g-3">
          <div class="col-md-3">
            <label class="form-label small mb-1">Search</label>
            <div class="input-group input-group-sm">
              <span class="input-group-text"><i class="bi bi-search"></i></span>
              <input class="form-control" ng-model="filters.search" placeholder="Client, PO, Project..." />
            </div>
          </div>

          <div class="col-md-2">
            <label class="form-label small mb-1">Item Type</label>
            <select class="form-select form-select-sm" ng-model="filters.type">
              <option value="">All Types</option>
              <option value="inv">Inventory</option>
              <option value="serial">Serialised-Inventory</option>
              <option value="lot">Lot-Inventory</option>
              <option value="serial_lot">Serialised Lot-Inventory</option>
            </select>
          </div>

          <div class="col-md-2">
            <div class="col-12">
              <label class="form-label small mb-1">From</label>
              <input
                type="date"
                class="form-control form-control-sm"
                ng-change="filterByDate()"
                ng-model="filters.dateRange"
              />
            </div>
            <!-- Custom Date Range Inputs -->
            <!-- <div class="mt-2 p-2 border rounded bg-light shadow-sm" ng-if="filters.dateRange === 'custom'">
              <div class="row g-2">
                <div class="col-12">
                  <label class="form-label small mb-1">From</label>
                  <input type="date" class="form-control form-control-sm" ng-model="filters.customFrom" />
                </div>
                <div class="col-12">
                  <label class="form-label small mb-1">To</label>
                  <input type="date" class="form-control form-control-sm" ng-model="filters.customTo" />
                </div>
              </div>
            </div> -->
          </div>

          <div class="col-md-2">
            <label class="form-label small mb-1">Delivery</label>
            <select class="form-select form-select-sm" ng-model="filters.delivery">
              <option value="">All Options</option>
              <option ng-repeat="option in deliveryOptions" value="{{option.name}}">{{option.name}}</option>
            </select>
          </div>

          <div class="col-md-3">
            <label class="form-label small mb-1">Location</label>
            <select class="form-select form-select-sm" ng-model="filters.location">
              <option value="">All Locations</option>
              <option ng-repeat="loc in locations" value="{{loc.name}}">{{loc.name}}</option>
            </select>
          </div>
        </div>
      </div>

      <div class="row g-3">
        <!-- SO List -->
        <div class="col-lg-8">
          <div class="card">
            <div class="card-title d-flex justify-content-between align-items-center">
              <span>Sales Orders</span>
              <span class="small text-muted" ng-if="totalDraftsAcrossSOs()>0">
                Draft assignments across SOs:
                <b>{{totalDraftsAcrossSOs()}}</b>
              </span>
            </div>
            <div class="card-body">
              <div class="accordion" id="soAccordion">
                <div
                  class="accordion-item"
                  ng-repeat="so in salesOrders | filter:filters.search"
                  ng-if="!filters.delivery || so.deliveryOption === filters.delivery"
                >
                  <h2 class="accordion-header">
                    <button
                      class="accordion-button collapsed py-2"
                      type="button"
                      data-bs-toggle="collapse"
                      data-bs-target="#so{{so.id}}"
                    >
                      <div class="so-header">
                        <div class="so-info">
                          <div class="small fw-semibold">{{so.documentNumber}} - {{so.customer}} - {{so.date}}</div>
                          <div class="so-meta">
                            <span class="me-2">{{so.totalQty}} Qty</span>
                            <span class="me-2">{{so.items.length}} Items</span>
                            <!-- <span class="badge bg-secondary me-2">{{so.type.toUpperCase()}}</span> -->
                            <span class="badge bg-secondary">{{so.deliveryOption}}</span>
                          </div>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                          <span class="assignment-badge bg-warning">
                            {{so.draftAssignedCount || 0}}/{{so.items.length}}
                          </span>
                          <span class="assignment-badge bg-warning text-dark" ng-if="so.draftAssignedCount > 0">
                            +{{so.draftAssignedCount}} draft
                          </span>
                        </div>
                      </div>
                    </button>
                  </h2>
                  <div id="so{{so.id}}" class="accordion-collapse collapse">
                    <div class="accordion-body py-2 px-3">
                      <table class="table table-hover table-sm compact-table mb-2">
                        <thead>
                          <tr>
                            <th>Item</th>
                            <th>Description</th>
                            <th>Loc</th>
                            <th>Qty</th>
                            <th>Type</th>
                            <th style="width: 250px">Picker</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr
                            ng-repeat="line in so.items | filter:locationFilter | filter:itemTypeFilter"
                            class="item-row"
                          >
                            <td>{{line.item}}</td>
                            <td>{{line.description}}</td>
                            <td>{{line.location}}</td>
                            <td>{{line.qty}}</td>
                            <td><span class="badge bg-secondary">{{line.type || 'INV'}}</span></td>
                            <td>
                              <!-- Bind to DRAFT picker selection -->
                              <div class="d-flex align-items-center gap-2">
                                <select
                                  class="form-select form-select-sm"
                                  ng-model="line.draftPicker"
                                  ng-change="onDraftChange()"
                                  ng-options="p as p.name for p in pickers track by p.id"
                                >
                                  <option value="">-- Select --</option>
                                </select>
                                <button
                                  class="btn btn-sm btn-outline-light"
                                  ng-if="line.draftPicker"
                                  ng-click="clearDraft(line)"
                                >
                                  <i class="bi bi-x"></i>
                                </button>
                              </div>
                              <div class="small mt-1" ng-if="line.draftPicker">
                                <span class="draft-chip">
                                  <i class="bi bi-pencil"></i>
                                  Draft: {{line.draftPicker.name}}
                                </span>
                              </div>
                              <div class="small text-success mt-1" ng-if="!line.draftPicker && line.savedPicker">
                                <i class="bi bi-check-circle"></i>
                                Assigned: {{line.savedPicker.name}}
                              </div>
                            </td>
                          </tr>
                        </tbody>
                      </table>

                      <!-- Assign Entire SO Button -->
                      <div class="d-flex justify-content-between align-items-center mt-2">
                        <div>
                          <span class="small text-secondary">Assign all to one picker (draft):</span>
                        </div>
                        <div class="d-flex">
                          <select
                            class="form-select form-select-sm w-auto me-2"
                            ng-model="so.bulkPicker"
                            ng-options="p as p.name for p in pickers track by p.id"
                          >
                            <option value="">-- Select --</option>
                          </select>
                          <button
                            class="btn btn-sm btn-primary"
                            ng-click="assignEntireSO(so)"
                            ng-disabled="!so.bulkPicker"
                          >
                            <i class="bi bi-check-all"></i>
                            Assign All (Draft)
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="alert alert-info mt-3 mb-0 mx-2 py-2 small" ng-if="salesOrders.length === 0">
                <i class="bi bi-info-circle"></i>
                No sales orders match your current filters.
              </div>
            </div>
          </div>
        </div>

        <!-- Picker Sidebar -->
        <div class="col-lg-4">
          <div class="card">
            <div class="card-title">Pickers</div>
            <div class="card-body">
              <div class="picker-header">
                <h6 class="mb-0">Team Status</h6>
                <div class="picker-status">
                  <span class="status-badge status-available"></span>
                  <span class="me-2">Available: {{getAvailablePickers().length}}</span>
                  <span class="status-badge status-busy"></span>
                  <span>Busy: {{getBusyPickers().length}}</span>
                </div>
              </div>

              <div class="list-group">
                <div class="picker-item" ng-repeat="p in pickers">
                  <div class="picker-name">
                    <span
                      class="status-badge"
                      ng-class="{'status-available': isPickerAvailable(p), 'status-busy': !isPickerAvailable(p)}"
                    ></span>
                    <span>{{p.name}}</span>
                    <span
                      class="badge ms-2"
                      ng-class="{'bg-success': isPickerAvailable(p), 'bg-warning': !isPickerAvailable(p)}"
                    >
                      {{isPickerAvailable(p) ? 'Available' : 'Busy'}}
                    </span>
                    <span class="pill" ng-if="isPickerAvailable(p) && p.draftItems > 0">will be busy after save</span>
                  </div>
                  <div class="picker-assignments">
                    <div>
                      <span class="badge rounded-pill bg-primary">{{p.currentAssignedItems}} items</span>
                      <span class="pill" ng-if="p.draftItems>0">+{{p.draftItems}} draft</span>
                    </div>
                    <div class="text-muted small">
                      Previously Assigned: {{p.baseAssignedItems}} • Draft Assigned: {{p.draftItems}}
                    </div>
                  </div>
                </div>
              </div>

              <!-- <div class="mt-3">
                <h6 class="mb-2">Status Breakdown</h6>
                <div class="d-flex flex-wrap gap-2">
                  <span class="badge status-pending">Pending: {{getStatusCount('pending')}}</span>
                  <span class="badge status-picked">Picked: {{getStatusCount('picked')}}</span>
                </div>
              </div> -->
            </div>
          </div>

          <div class="card mt-3">
            <div class="card-title">Quick Actions</div>
            <div class="card-body quick-actions">
              <button class="btn btn-outline-light" ng-click="showAssignmentHistory()">
                <i class="bi bi-clock-history me-2"></i>
                View Assignment History
              </button>
              <!-- <button class="btn btn-outline-light" ng-click="refreshScreen()">
                <i class="bi bi-printer me-2"></i>
                Print Assignments
              </button>
              <button class="btn btn-outline-light">
                <i class="bi bi-arrow-left-right me-2"></i>
                Reassign Items
              </button>
              <button class="btn btn-outline-light">
                <i class="bi bi-graph-up me-2"></i>
                Performance Report
              </button> -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Assignment History Modal -->
    <div
      class="modal fade"
      id="assignmentHistoryModal"
      tabindex="-1"
      aria-labelledby="assignmentHistoryLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content shadow">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title fw-bold" id="assignmentHistoryLabel">
              <i class="bi bi-clock-history me-2"></i>
              Assignment History
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body bg-light">
            <div class="table-responsive" style="max-height: 50vh; overflow-y: auto">
              <table class="table table-bordered table-hover table-sm align-middle mb-0">
                <thead class="table-secondary sticky-top">
                  <tr>
                    <th>Assignment ID</th>
                    <th>Assignment Header</th>
                    <th>Sales Order</th>
                    <th>Item</th>
                    <th>Picker</th>
                    <th>Assigned By</th>
                    <th>Assignment Type</th>
                    <th>Qty</th>
                  </tr>
                </thead>
                <tbody>
                  <tr ng-repeat="a in assignmentHistory">
                    <td>{{a.assignmentId}}</td>
                    <td>{{a.assignmentHeaderLink}}</td>
                    <td>{{a.salesOrder}}</td>
                    <td>{{a.item}}</td>
                    <td>{{a.picker}}</td>
                    <td>{{a.assignedBy}}</td>
                    <td>{{a.assignType}}</td>
                    <td>{{a.qty}}</td>
                  </tr>
                  <tr ng-if="assignmentHistory.length === 0">
                    <td colspan="9" class="text-center text-muted">No assignment history found.</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
